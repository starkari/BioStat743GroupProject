---
title: "Presentation"
author: "Minsu Kim, Alona Muzikansky, Ariane Stark, Jadey Wu"
output: 
  beamer_presentation:
    theme: "Madrid"

---

```{r setup, include=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(gtable)
library(gridExtra)
library(DescTools)
library(tidyverse)
library(kableExtra)
library(knitr)
library(tidyverse)
library(vcdExtra, quietly = TRUE)
library(ResourceSelection)
library(nnet)
```


```{r include=FALSE}
data <- read.csv("Data/initial_table.csv")
#mean(data$AGE, na.rm = T)
data.work <- dplyr::select(data, ID, AGE, SEX, IBS_POST, DLIT_AG, SIM_GIPERT, endocr_01, endocr_02, ZSN, LET_IS) 
data.work <- na.omit(data.work)
data.work <- filter(data.work, DLIT_AG != 10)
```


## Introduction 

Introduction text here

## Descriptive statistics

- Demographic information
```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align="center"}
# distribution plots for single variable

age.hist <- ggplot(data.work, aes(data.work$AGE)) + geom_histogram() + 
  labs(title = "age distribution", x = "age") + 
  geom_vline(xintercept = mean(data.work$AGE), color = "blue") + 
  geom_vline(xintercept = median(data.work$AGE), linetype = "dotted") +
  annotate("text", x = 40, y = 120, label = "mean = 61.397") +
  annotate("text", x = 40, y = 110, label = "median = 62") 
#age.hist

sex.plot <- ggplot(data.work, aes(as.factor(data.work$SEX))) + geom_bar() + 
  labs(title = "distribution of sex", x = "sex", y = "") + 
  scale_x_discrete(labels = c("female", "male")) +
  annotate("text", x = 1, y = 780, label = "female = 502") +
  annotate("text", x = 1, y = 720, label = "male = 878") 
#sex.plot

grid.arrange(age.hist, sex.plot, nrow = 1)

```

## Descriptive statistics
- Patient physiological attributes
- IBS_POST: coronary heart disease in recen weeks before admission to hospital
  - 0: there was no CHD
  - 1: extertional angina pectoris
  - 2: unstable angina pectoris

- DLIT_AG: duration of arterial hypertension
  - 0: there was no arterial hypertension
  - 1: one year
  - 2: two years
  - 3: three years
  - 4: four years
  - 5: five years
  - 6: 6-10 years
  - 7: more than 10 years
  
## Descriptive statistics  
- SIM_GIPERT: systematic hypertension; 0 - no, 1 - yes
- endocr_01: diabetes mellitus in the anamnesis; 0 - no, 1 - yes
- endocr_02: obesity in the anamnesis; 0 - no, 1 - yes
- ZSN: chronic heart failure; 0 - no, 1 - yes

## Descriptive statistics

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.align = "center"}
ibs.plot <- ggplot(data.work, aes(as.factor(data.work$IBS_POST))) + 
  geom_bar() + 
  labs(title = "IBS_POST", x = "type of CHD") +
  annotate("text", x = 1, y = 560, label = "0: 353") +
  annotate("text", x = 1, y = 500, label = "1: 443") +
  annotate("text", x = 1, y = 440, label = "2: 584") 
#ibs.plot

duration.hist <- ggplot(data.work, aes(data.work$DLIT_AG)) + 
  geom_histogram() + 
  labs(title = "DLIT_AG", x = "years", y = "") +
  annotate("text", x = 4, y = 450, label = "mean = 3.34") +
  annotate("text", x = 4, y = 380, label = "median = 3") 
#duration.hist

hypertension.plot <- ggplot(data.work, aes(as.factor(data.work$SIM_GIPERT))) + 
  geom_bar() + 
  labs(title = "SIM_GIPERT", x = "hypertension", y = "") + 
  scale_x_discrete(labels = c("no", "yes")) + 
  annotate("text", x = 2, y = 1100, label = "no: 1336") +
  annotate("text", x = 2, y = 900, label = "yes: 44") 
#hypertension.plot

diabetes.plot <- ggplot(data.work, aes(as.factor(data.work$endocr_01))) + 
  geom_bar() + 
  labs(title = "endocr_01", x = "diabetes") + 
  scale_x_discrete(labels = c("no", "yes")) +
  annotate("text", x = 2, y = 1100, label = "no: 1193") +
  annotate("text", x = 2, y = 900, label = "yes: 187") 
#diabetes.plot

obesity.plot <- ggplot(data.work, aes(as.factor(data.work$endocr_02))) + 
  geom_bar() + 
  labs(title = "endocr_02", x = "obesity", y = "") + 
  scale_x_discrete(labels = c("no", "yes")) +
  annotate("text", x = 2, y = 1100, label = "no: 1348") +
  annotate("text", x = 2, y = 900, label = "yes: 32") 
#obesity.plot

chd.plot <- ggplot(data.work, aes(as.factor(data.work$ZSN))) + 
  geom_bar() + 
  labs(title = "ZSN", x = "CHD", y = "") + 
  scale_x_discrete(labels = c("no", "yes")) +
  annotate("text", x = 2, y = 950, label = "no: 1052") +
  annotate("text", x = 2, y = 800, label = "yes: 328") 
#chd.plot

grid.arrange(ibs.plot, duration.hist, hypertension.plot, diabetes.plot, obesity.plot, chd.plot, nrow = 2)
```



## Ariane: Analysis of Sex and Chronic Heart Failure: Overview

Question: Is there an association between sex and chronic heart failure?

```{r echo=FALSE,comment=NA }
data_sex_chf <- table(data.work$SEX,data.work$ZSN)
dimnames(data_sex_chf) <- list(Sex=c("Female","Male"),         
                       "Chronic Heart Failure"=c("No","Yes"))
data_sex_chf
```

## Analysis of Sex and Chronic Heart Failure: Tests

Pearson $\chi^2$ Test of Independence:

```{r echo=FALSE,  comment=NA}
chi_sq_data_sex_chf <-chisq.test(data_sex_chf)
chi_sq_data_sex_chf$statistic
cat(paste("p-value =",round(chi_sq_data_sex_chf$p.value,5)))
```

Likelihood Ratio Test of Independence:

```{r echo=FALSE,comment=NA}
LR_data_sex_chf <- GTest(data_sex_chf)
LR_data_sex_chf$statistic
cat(paste("p-value =",round(LR_data_sex_chf$p.value,5)))
```
## Analysis of Age(Continuous) and Chronic Heart Failure: Overview

Question: Is there an association between age and chronic heart failure?
```{r echo=FALSE, fig.height=5.75, comment=NA}
# age and chronic heart failure
data_age_chf <- table(data.work$AGE,data.work$ZSN)
dimnames(data_age_chf) <- list(Age = names(data_age_chf[,1]),
                               "Chronic Heart Failure"=c("No","Yes"))
#data_age_chf

boxplot_age_chf <- data.work %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x=AGE, y=as.factor(ZSN), 
                             group = as.factor(ZSN))) +
  ylab("Chronic Heart Failure") +
  scale_y_discrete(labels=c("No","Yes"))
boxplot_age_chf
```

## Analysis of Age(Continuous) and Chronic Heart Failure: Summary Statistics

```{r echo=FALSE,comment=NA}
#CHF NO
chf_no <- summary(data.work %>% 
          filter(ZSN==0) %>% 
          select(AGE))

#CHF YES
chf_yes <- summary(data.work %>% 
          filter(ZSN==1) %>% 
          select(AGE))

chf_age_cont_descriptive_statistcs <- data.work %>% 
  transform("ZSN" = ifelse(ZSN==1,"Yes","No")) %>% 
  group_by(ZSN) %>% 
  summarise_at(vars("AGE"), list( "Min." = min,
            "1st Qu." = ~quantile(.,prob=0.25),
            "Median" = ~quantile(.,prob=0.5),
            "Mean" = mean,
            "3rd Qu." = ~quantile(.,prob=0.75),
            "Max" = max)) 

chf_age_cont_descriptive_statistcs_t <-
  as.table(t(as.matrix.data.frame(chf_age_cont_descriptive_statistcs)))[-1,]


dimnames(chf_age_cont_descriptive_statistcs_t) <- list(" "=rownames(chf_age_cont_descriptive_statistcs_t),         
                       "Chronic Heart Failure"=c("No","Yes"))

print(chf_age_cont_descriptive_statistcs_t)
```

## Analysis of Age(Continuous) and Chronic Heart Failure: Test

Analysis was done using a two sided Wilcoxon Rank Sum Test to test if there is a difference in Chronic Heart Failure outcome across age.

```{r echo=FALSE,comment=NA}
wilcox_test <- wilcox.test(data.work$AGE[which(data.work$ZSN == 0)],
            data.work$AGE[which(data.work$ZSN == 1)])
wilcox_test$statistic
cat(paste("p-value =",round(wilcox_test$p.value,8)))
```
## Analysis of Age(Categorical) and Chronic Heart Failure: Overview

Question: Is there an association between age(decade) and chronic heart failure?
```{r echo=FALSE,comment=NA}
age_decade <- data.work %>% 
  mutate(decade = floor(AGE/10)*10) %>% 
  select(decade)
data_age_decade_chf <- table(age_decade$decade,data.work$ZSN)
dimnames(data_age_decade_chf) <- 
  list(Age = paste0(names(data_age_decade_chf[,1]),"s"),
                               "Chronic Heart Failure"=c("No","Yes"))
data_age_decade_chf
```

## Analysis of Age(Categorical) and Chronic Heart Failure: Test

Pearson $\chi^2$ Test of Independence:
```{r echo=FALSE, message=FALSE, warning=FALSE, comment=NA}
chi_sq_data_age_decade_chf <-chisq.test(data_age_decade_chf)
chi_sq_data_age_decade_chf$statistic
cat(paste("p-value =",round(chi_sq_data_age_decade_chf$p.value,5)))
```

Likelihood Ratio Test of Independence:
```{r echo=FALSE,comment=NA}
LR_data_age_decade_chf <- GTest(data_age_decade_chf)
LR_data_age_decade_chf$statistic
cat(paste("p-value =",round(LR_data_age_decade_chf$p.value,8)))
```


## Alona

Alona

## Minsu

Minsu

## Jadey

## Secondary analysis - modeling the relationship between death outcome and selected variables 
- The dataset includes one variable indicating the causes of lethal outcome for the patients
  - LET_IS: causes of lethal outcome
    - 0: survive
    - 1: cardiogenic edema
    - 2: pulmonary edema
    - 3: myocardial rupture
    - 4: progress of congestive heart failure
    - 5: thromboembolism
    - 6: asystole
    - 7: ventricular fibrillation
- Build a logistic regression model to predict death of the patients by turning LET_IS to a binary variable "death"
- Build model with multimonial response to investigate the cause of death

## Secondary analysis - modeling the relationship between death outcome and selected variables
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
data.work2 <- data.work
data.work2$death <- ifelse(data.work$LET_IS == 0, 0, 1)
#table(data.work2$death) # survive: 1212, dead: 191

death.plot <- ggplot(data.work, aes(as.factor(data.work2$death))) + 
  geom_bar() + 
  labs(title = "distribution of death", x = "death") + 
  scale_x_discrete(labels = c("no", "yes")) +
  annotate("text", x = 2, y = 1000, label = "no: 1212") +
  annotate("text", x = 2, y = 800, label = "yes: 191")

data.work3 <- filter(data.work2, LET_IS != 0)
#dim(data.work3) # n = 191
#table(data.work3$LET_IS)
cause.plot <- ggplot(data.work3, aes(as.factor(data.work3$LET_IS))) + 
  geom_bar() + 
  labs(title = "causes of death") + 
  xlab("") + 
  scale_x_discrete(labels = c("cardiogenic shock", "pulmonary endema", "myocardial rupture", "progress of conestive heart failure", "thromboembolism", "asystole", "ventricular fibrillation"), guide = guide_axis(n.dodge = 2))

grid.arrange(death.plot, cause.plot, nrow = 2)
```


## Secondary analysis
- Full model contains continuous variables AGE, DLIT_AG, categorical variables SEX, IBS_POST, SIM_GIPERT, endocr_01, endocr_02, and the interaction terms between AGE and all the other variables.
- Used stepwise step() to select the best model.
- The best model selected:

$log \frac{\pi_i}{ 1 - \pi_i} = -6.018 + 0.058 \times AGE + 0.073 \times I(IBS = 1) + 0.696 \times I(IBS = 2) + 0.726 \times I(SIM = 1) + 0.476 \times I(endocr01 = 1) + 1.081 \times I(endocr02 = 1)$

- All selected predictors increase the probability of death. 
  - exp(beta_age) = 1.06
  - OR(IBS_POST = 1 vs. IBS_POST = 0) = 1.08 (p = 0.77 > 0.5)
  - OR(IBS_POST = 2 vs. IBS_POST = 0) = 2.01
  - OR(hypertension vs. non hypertension) = 2.07 (p = 0.065 > 0.5)
  - OR(diabetes vs. non diabetes) = 1.61
  - OR(obese vs. not obese) = 2.95
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# use stepwise selection to select variable
death.fit0 <- glm(death ~ 1, data = data.work2, family = binomial)
death.fit1 <- glm(death ~ AGE + as.factor(SEX) + as.factor(IBS_POST) + DLIT_AG + as.factor(SIM_GIPERT) + as.factor(endocr_01) + as.factor(endocr_02) + AGE * factor(IBS_POST) + AGE * DLIT_AG + AGE * factor(SIM_GIPERT) + AGE * factor(endocr_01) + AGE * factor(endocr_02), data = data.work2, family = binomial)
step(death.fit1, death.fit0, direction = "both", trace = F) # selected variable: AGE, IBS_POST, SIM_GIPERT, endocr_01, endocr_02

# fit the best model 
death.fit.logit <- glm(death ~ AGE + as.factor(IBS_POST) + as.factor(SIM_GIPERT) + as.factor(endocr_01) + as.factor(endocr_02), data = data.work2, family = binomial)
summary(death.fit.logit)
deviance(death.fit.logit) # 1018.906

exp(death.fit.logit$coefficients)
```

## Secondary analysis

- Goodness of fit check with Hosmer-Lemeshow test by grouping the observations into 20 groups. The test statistic is 0.4291, indicating an adequate fit of the model to the dataset.
- Plotted the predicted value against the observed value of the 20 groups. Overall the dots follow the diagonal. 

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# Hosmer-Lemeshow test to check goodness of fit
library("ResourceSelection")
death.pred <- predict(death.fit.logit, data.work2, type = "response")
hoslem.test(data.work2$death, death.pred, g = 20) # p = 0.4291, fail to reject H0
```

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
## Get indices of vector fit, from smallest to greatest
fit <- death.fit.logit$fitted.values
index <- sort.list(fit)
## check 10 smallest indices
index[1:10]
## create a matrix of death and fit, using this index
hosmer <- matrix(c(data.work2$death[index], fit[index]), byrow = F, nrow = nrow(data.work2))
head(hosmer)
## group into 20 groups with 69 observations per group
observed <- rep(NA, 20)
for (i in 1:20){ observed[i] <- sum(hosmer[(69*(i-1) +1) : (69 *i), 1])/ 69 }
observed
# repeat the previous step for the predicted probability
predicted <- rep(NA, 20)
for (i in 1:20){ predicted[i] <- sum(hosmer[(69*(i-1) +1) : (69 *i), 2])/ 69 }
predicted
```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.width = "200px", out.height="300px", fig.align = "center"}
# plot observed versus predicted
ggplot() + aes(x = predicted, y = observed) + geom_point() + geom_line() + geom_abline( a = 0, b = 1, color = "red")
```


## Secondary analysis
- Fit baseline category logit model on cause of death. Used predictors selected in the previous analysis. 
$log \frac{\pi_j(x)}{\pi_J(x)} = \beta_{0j} + \beta_{1j} \times AGE + \beta_{2j} \times I(IBS = 1) + \beta_{3j} \times I(IBS = 2) + \beta_{4j} \times I(SIM = 1) + \beta_{5j} \times I(endocr01 = 1) + \beta_{6j} \times I(endocr02 = 1), j = 1, ..., 6$

where J = cardiogenic shock, j = 1 pulmonary edema, 2 myocardial rupture, 3 progress of congestive heart failure, 4 thromboembolism, 5 asystole, 6 ventricular fibrillation

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
multi.mod <- multinom(LET_IS ~ AGE + as.factor(IBS_POST) + as.factor(SIM_GIPERT) + as.factor(endocr_01) + as.factor(endocr_02), data = data.work3)
```

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE, out.width = "200px", out.height="300px", fig.align="cente"}
output <- summary(multi.mod)
table <- as.data.frame(output$coefficients)
colnames(table) <- c("intercept", "AGE", "IBS_POST = 1", "IBS_POST = 2", "SIM_GIPERT = 1", "endocr_01 = 1", "endocr_02 = 1")
```

## Secondary analysis
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
print(table)
```

## Secondary analysis
Estimated $exp(\beta_{ij})$:
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
print(exp(table))
```


